from datetime import datetime, timezone\n\nfrom fastapi import Depends, FastAPI, HTTPException\n\nfrom ranksentinel.config import Settings, get_settings\nfrom ranksentinel.db import connect, execute, fetch_all, fetch_one, init_db\nfrom ranksentinel.models import CustomerCreate, CustomerOut, CustomerSettingsPatch, TargetCreate, TargetOut\n\n\ndef now_iso() -> str:\n    return datetime.now(timezone.utc).isoformat()\n\n\ndef get_conn(settings: Settings = Depends(get_settings)):\n    conn = connect(settings)\n    try:\n        init_db(conn)\n        yield conn\n    finally:\n        conn.close()\n\n\napp = FastAPI(title=\"RankSentinel Admin API\", version=\"0.1.0\")\n\n\n@app.get(\"/health\")\ndef health():\n    return {\"status\": \"ok\"}\n\n\n@app.post(\"/admin/customers\", response_model=CustomerOut)\ndef create_customer(payload: CustomerCreate, conn=Depends(get_conn)):\n    ts = now_iso()\n    customer_id = execute(\n        conn,\n        \"INSERT INTO customers(name,status,created_at,updated_at) VALUES(?,?,?,?)\",\n        (payload.name, \"active\", ts, ts),\n    )\n    execute(conn, \"INSERT OR IGNORE INTO settings(customer_id) VALUES(?)\", (customer_id,))\n    row = fetch_one(conn, \"SELECT id,name,status FROM customers WHERE id=?\", (customer_id,))\n    return CustomerOut(**dict(row))\n\n\n@app.get(\"/admin/customers\", response_model=list[CustomerOut])\ndef list_customers(conn=Depends(get_conn)):\n    rows = fetch_all(conn, \"SELECT id,name,status FROM customers ORDER BY id DESC\")\n    return [CustomerOut(**dict(r)) for r in rows]\n\n\n@app.post(\"/admin/customers/{customer_id}/targets\", response_model=TargetOut)\ndef add_target(customer_id: int, payload: TargetCreate, conn=Depends(get_conn)):\n    cust = fetch_one(conn, \"SELECT id FROM customers WHERE id=?\", (customer_id,))\n    if not cust:\n        raise HTTPException(status_code=404, detail=\"customer not found\")\n\n    ts = now_iso()\n    tid = execute(\n        conn,\n        \"INSERT INTO targets(customer_id,url,is_key,created_at) VALUES(?,?,?,?)\",\n        (customer_id, str(payload.url), 1 if payload.is_key else 0, ts),\n    )\n    row = fetch_one(conn, \"SELECT id,customer_id,url,is_key FROM targets WHERE id=?\", (tid,))\n    return TargetOut(**dict(row))\n\n\n@app.get(\"/admin/customers/{customer_id}/targets\", response_model=list[TargetOut])\ndef list_targets(customer_id: int, conn=Depends(get_conn)):\n    rows = fetch_all(\n        conn,\n        \"SELECT id,customer_id,url,is_key FROM targets WHERE customer_id=? ORDER BY id DESC\",\n        (customer_id,),\n    )\n    return [TargetOut(**dict(r)) for r in rows]\n\n\n@app.patch(\"/admin/customers/{customer_id}/settings\")\ndef patch_settings(customer_id: int, payload: CustomerSettingsPatch, conn=Depends(get_conn)):\n    cust = fetch_one(conn, \"SELECT id FROM customers WHERE id=?\", (customer_id,))\n    if not cust:\n        raise HTTPException(status_code=404, detail=\"customer not found\")\n\n    existing = fetch_one(conn, \"SELECT * FROM settings WHERE customer_id=?\", (customer_id,))\n    if not existing:\n        execute(conn, \"INSERT INTO settings(customer_id) VALUES(?)\", (customer_id,))\n\n    updates: list[str] = []\n    params: list[object] = []\n\n    if payload.sitemap_url is not None:\n        updates.append(\"sitemap_url=?\")\n        params.append(str(payload.sitemap_url))\n\n    if payload.crawl_limit is not None:\n        updates.append(\"crawl_limit=?\")\n        params.append(payload.crawl_limit)\n\n    if payload.psi_enabled is not None:\n        updates.append(\"psi_enabled=?\")\n        params.append(1 if payload.psi_enabled else 0)\n\n    if payload.psi_urls_limit is not None:\n        updates.append(\"psi_urls_limit=?\")\n        params.append(payload.psi_urls_limit)\n\n    if not updates:\n        return {\"status\": \"no changes\"}\n\n    params.append(customer_id)\n    execute(conn, f\"UPDATE settings SET {', '.join(updates)} WHERE customer_id=?\", params)\n    return {\"status\": \"ok\"}\n
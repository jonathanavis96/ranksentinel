import sqlite3\nfrom pathlib import Path\nfrom typing import Any, Iterable\n\nfrom ranksentinel.config import Settings\n\n\nSCHEMA_SQL = \"\"\"\nPRAGMA journal_mode=WAL;\n\nCREATE TABLE IF NOT EXISTS customers (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  name TEXT NOT NULL,\n  status TEXT NOT NULL CHECK(status IN ('active','past_due','canceled')),\n  created_at TEXT NOT NULL,\n  updated_at TEXT NOT NULL\n);\n\nCREATE TABLE IF NOT EXISTS targets (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  customer_id INTEGER NOT NULL,\n  url TEXT NOT NULL,\n  is_key INTEGER NOT NULL DEFAULT 1,\n  created_at TEXT NOT NULL,\n  FOREIGN KEY(customer_id) REFERENCES customers(id)\n);\n\nCREATE TABLE IF NOT EXISTS settings (\n  customer_id INTEGER PRIMARY KEY,\n  sitemap_url TEXT,\n  crawl_limit INTEGER NOT NULL DEFAULT 100,\n  psi_enabled INTEGER NOT NULL DEFAULT 1,\n  psi_urls_limit INTEGER NOT NULL DEFAULT 5,\n  psi_confirm_runs INTEGER NOT NULL DEFAULT 2,\n  psi_perf_drop_threshold INTEGER NOT NULL DEFAULT 10,\n  psi_lcp_increase_threshold_ms INTEGER NOT NULL DEFAULT 500,\n  FOREIGN KEY(customer_id) REFERENCES customers(id)\n);\n\nCREATE TABLE IF NOT EXISTS findings (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  customer_id INTEGER NOT NULL,\n  run_type TEXT NOT NULL CHECK(run_type IN ('daily','weekly')),\n  severity TEXT NOT NULL CHECK(severity IN ('critical','warning','info')),\n  category TEXT NOT NULL,\n  title TEXT NOT NULL,\n  details_md TEXT NOT NULL,\n  url TEXT,\n  created_at TEXT NOT NULL,\n  FOREIGN KEY(customer_id) REFERENCES customers(id)\n);\n\nCREATE TABLE IF NOT EXISTS deliveries (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  customer_id INTEGER NOT NULL,\n  run_type TEXT NOT NULL CHECK(run_type IN ('daily','weekly')),\n  sent_at TEXT NOT NULL,\n  recipient TEXT NOT NULL,\n  subject TEXT NOT NULL,\n  provider TEXT NOT NULL,\n  provider_message_id TEXT,\n  status TEXT NOT NULL CHECK(status IN ('sent','skipped','failed')),\n  error TEXT,\n  FOREIGN KEY(customer_id) REFERENCES customers(id)\n);\n\"\"\"\n\n\ndef connect(settings: Settings) -> sqlite3.Connection:\n    db_path = Path(settings.RANKSENTINEL_DB_PATH)\n    db_path.parent.mkdir(parents=True, exist_ok=True)\n    conn = sqlite3.connect(str(db_path))\n    conn.row_factory = sqlite3.Row\n    return conn\n\n\ndef init_db(conn: sqlite3.Connection) -> None:\n    conn.executescript(SCHEMA_SQL)\n    conn.commit()\n\n\ndef fetch_all(conn: sqlite3.Connection, sql: str, params: Iterable[Any] = ()) -> list[sqlite3.Row]:\n    cur = conn.execute(sql, tuple(params))\n    return list(cur.fetchall())\n\n\ndef fetch_one(conn: sqlite3.Connection, sql: str, params: Iterable[Any] = ()) -> sqlite3.Row | None:\n    cur = conn.execute(sql, tuple(params))\n    return cur.fetchone()\n\n\ndef execute(conn: sqlite3.Connection, sql: str, params: Iterable[Any] = ()) -> int:\n    cur = conn.execute(sql, tuple(params))\n    conn.commit()\n    return int(cur.lastrowid)\n
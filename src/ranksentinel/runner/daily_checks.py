import hashlib\nimport json\nimport time\nfrom datetime import datetime, timezone\nfrom typing import Any\n\nimport requests\n\nfrom ranksentinel.config import Settings\nfrom ranksentinel.db import connect, execute, fetch_all, init_db\nfrom ranksentinel.runner.normalization import normalize_html_to_text\n\n\ndef now_iso() -> str:\n    return datetime.now(timezone.utc).isoformat()\n\n\ndef sha256_text(s: str) -> str:\n    return hashlib.sha256((s or \"\").encode(\"utf-8\")).hexdigest()\n\n\ndef retry(fn, attempts: int = 3, base_delay_s: float = 1.0):\n    last = None\n    for i in range(attempts):\n        try:\n            return fn()\n        except Exception as e:  # noqa: BLE001\n            last = e\n            time.sleep(base_delay_s * (2**i))\n    raise last  # type: ignore[misc]\n\n\ndef fetch_url(url: str, timeout_s: int = 20) -> dict[str, Any]:\n    resp = requests.get(\n        url,\n        timeout=timeout_s,\n        allow_redirects=True,\n        headers={\"User-Agent\": \"RankSentinel/0.1\"},\n    )\n    chain = [r.url for r in resp.history] + [resp.url]\n    ct = resp.headers.get(\"content-type\", \"\").lower()\n    html = resp.text if ct.startswith(\"text/html\") else \"\"\n    text = normalize_html_to_text(html) if html else \"\"\n    return {\n        \"status_code\": int(resp.status_code),\n        \"final_url\": resp.url,\n        \"redirect_chain\": chain,\n        \"content_hash\": sha256_text(text),\n    }\n\n\ndef run(settings: Settings) -> None:\n    \"\"\"Bootstrap-level daily run.\n\n    Full daily logic (robots/sitemap/canonical/noindex/severity/email) is implemented in later phases.\n    \"\"\"\n    conn = connect(settings)\n    try:\n        init_db(conn)\n        customers = fetch_all(conn, \"SELECT id FROM customers WHERE status='active'\")\n\n        for c in customers:\n            customer_id = int(c[\"id\"])\n            targets = fetch_all(\n                conn,\n                \"SELECT url FROM targets WHERE customer_id=? AND is_key=1\",\n                (customer_id,),\n            )\n            for t in targets:\n                url = str(t[\"url\"])\n                data = retry(lambda: fetch_url(url))\n                execute(\n                    conn,\n                    \"INSERT INTO findings(customer_id,run_type,severity,category,title,details_md,url,created_at) \"\n                    \"VALUES(?,?,?,?,?,?,?,?)\",\n                    (\n                        customer_id,\n                        \"daily\",\n                        \"info\",\n                        \"bootstrap\",\n                        \"Daily check executed (bootstrap)\",\n                        \"\\n\".join(\n                            [\n                                f\"- URL: `{url}`\",\n                                f\"- Status: `{data['status_code']}`\",\n                                f\"- Final URL: `{data['final_url']}`\",\n                                f\"- Content hash: `{data['content_hash']}`\",\n                                f\"- Redirect chain: `{json.dumps(data['redirect_chain'])}`\",\n                            ]\n                        )\n                        + \"\\n\",\n                        url,\n                        now_iso(),\n                    ),\n                )\n    finally:\n        conn.close()\n